//
// LoginView.swift
// Click to Buy
//

import SwiftUI
import AuthenticationServices

struct LoginView: View {
    @EnvironmentObject var authManager: AuthManager
    @State private var email = ""
    @State private var password = ""
    @State private var showingSignup = false
    @State private var showingError = false

    var body: some View {
        NavigationView {
            VStack {
                Text(LocalizedStringKey("welcome_back_title"))
                    .font(.largeTitle).bold()
                    .padding(.bottom, 40)
                    .accessibilityLabel(LocalizedStringKey("welcome_back_accessibility"))

                TextField(LocalizedStringKey("email_placeholder"), text: $email)
                    .keyboardType(.emailAddress)
                    .autocapitalization(.none)
                    .padding()
                    .background(Color.secondary.opacity(0.1))
                    .cornerRadius(10)
                    .padding(.horizontal)
                    .accessibilityLabel(LocalizedStringKey("email_accessibility"))

                SecureField(LocalizedStringKey("password_placeholder"), text: $password)
                    .padding()
                    .background(Color.secondary.opacity(0.1))
                    .cornerRadius(10)
                    .padding(.horizontal)
                    .padding(.bottom, 20)
                    .accessibilityLabel(LocalizedStringKey("password_accessibility"))

                Button(LocalizedStringKey("login_button")) {
                    Task {
                        await authManager.login(email: email, password: password)
                    }
                }
                .font(.headline)
                .foregroundColor(.white)
                .padding()
                .frame(maxWidth: .infinity)
                .background(Color.accentColor)
                .cornerRadius(10)
                .padding(.horizontal)
                .accessibilityLabel(LocalizedStringKey("login_accessibility"))

                // Google Sign-In Button
                Button(action: {
                    Task {
                        if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene,
                           let rootViewController = windowScene.windows.first?.rootViewController {
                            await authManager.signInWithGoogle(presenting: rootViewController)
                        }
                    }
                }) {
                    HStack {
                        Image(systemName: "g.circle.fill")
                        Text(LocalizedStringKey("google_signin_button"))
                    }
                    .font(.headline)
                    .foregroundColor(.white)
                    .padding()
                    .frame(maxWidth: .infinity)
                    .background(Color.blue)
                    .cornerRadius(10)
                }
                .padding(.horizontal)
                .padding(.top, 10)
                .accessibilityLabel(LocalizedStringKey("google_signin_accessibility"))

                // Apple Sign-In Button
                SignInWithAppleButton(
                    .signIn,
                    onRequest: { request in
                        request = authManager.startSignInWithAppleFlow()
                    },
                    onCompletion: { result in
                        switch result {
                        case .success(let authorization):
                            Task {
                                await authManager.signInWithApple(authorization: authorization)
                            }
                        case .failure(let error):
                            DispatchQueue.main.async {
                                authManager.authError = error
                                showingError = true
                            }
                        }
                    }
                )
                .frame(height: 50)
                .padding(.horizontal)
                .padding(.top, 10)
                .accessibilityLabel(LocalizedStringKey("apple_signin_accessibility"))

                Spacer()

                Button(LocalizedStringKey("signup_prompt")) {
                    showingSignup = true
                }
                .padding(.bottom, 20)
                .accessibilityLabel(LocalizedStringKey("signup_accessibility"))

                if let error = authManager.authError {
                    Text(error.localizedDescription)
                        .foregroundColor(.red)
                        .padding(.top, 10)
                }
            }
            .navigationTitle(LocalizedStringKey("login_title"))
            .navigationBarHidden(true)
            .fullScreenCover(isPresented: $showingSignup) {
                SignupView()
                    .environmentObject(authManager)
            }
            .alert(isPresented: $showingError) {
                Alert(
                    title: Text(LocalizedStringKey("error_title")),
                    message: Text(authManager.authError?.localizedDescription ?? ""),
                    dismissButton: .default(Text(LocalizedStringKey("ok_button"))) {
                        authManager.authError = nil
                    }
                )
            }
        }
    }
}
